name: Validate AI MindLayer

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    name: Validate .ai.json Schema

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: Install dependencies
        run: |
          npm install -g ajv-cli
          npm install -g jsonlint

      - name: Validate JSON syntax
        run: |
          echo "ðŸ” Validating JSON syntax..."
          jsonlint .ai.json.example
          if [ -f .ai.json ]; then
            jsonlint .ai.json
          fi

      - name: Validate against schema
        run: |
          echo "ðŸ“‹ Validating against schema..."
          ajv validate -s schema.json -d .ai.json.example
          if [ -f .ai.json ]; then
            ajv validate -s schema.json -d .ai.json
          fi

      - name: Check documentation links
        run: |
          echo "ðŸ”— Checking documentation..."
          test -f README.md
          test -f INSTALL.md
          test -f AI-INTEGRATION.md
          test -f LICENSE
          test -f CONTRIBUTING.md
          test -f CHANGELOG.md
          test -f TODO.md
          echo "âœ… All documentation files exist"

  lint-php:
    runs-on: ubuntu-latest
    name: Lint PHP Files

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: Validate PHP syntax
        run: |
          echo "ðŸ” Validating PHP syntax..."
          find . -name "*.php" -exec php -l {} \;
          echo "âœ… PHP syntax validation complete"

  test-integration:
    runs-on: ubuntu-latest
    name: Test AI Integration

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: Test ai-init.php
        run: |
          echo "ðŸ§ª Testing ai-init.php..."
          php -f ai-init.php
          echo "âœ… AI init script works"

      - name: Test standalone PHP scanner
        run: |
          echo "ðŸ§ª Testing standalone PHP scanner..."
          mkdir -p test-project && cd test-project
          cp ../scripts/ecosystem/php-scanner/PhpProjectScanner.php .
          echo '{"name": "test/project", "description": "Test project"}' > composer.json
          php PhpProjectScanner.php
          test -f .ai.json && echo "âœ… Standalone PHP scanner works"
          cd .. && rm -rf test-project

      - name: Test direct Composer plugin execution
        run: |
          echo "ðŸ§ª Testing direct Composer plugin execution..."
          mkdir -p test-plugin && cd test-plugin
          cp -r ../scripts/ecosystem/composer-plugin .
          cp -r ../scripts/ecosystem/php-scanner .
          echo '{"name": "test/project", "description": "Test plugin execution"}' > composer.json
          php composer-plugin/src/ComposerPlugin.php
          test -f .ai.json && echo "âœ… Direct composer plugin execution works"
          cd .. && rm -rf test-plugin

      - name: Verify project structure
        run: |
          echo "ðŸ“ Verifying project structure..."
          test -f .ai.json.example
          test -f ai-init.php
          test -f schema.json
          echo "âœ… Required files present"

      - name: Test example validation
        run: |
          echo "âœ¨ Testing if example validates..."
          npm install -g ajv-cli
          ajv validate -s schema.json -d .ai.json.example
          echo "âœ… Example file validates successfully"

  test-composer-integration:
    runs-on: ubuntu-latest
    name: Test With Composer Installation

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP with Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:v2

      - name: Verify Composer installation
        run: |
          echo "ðŸ” Verifying Composer installation..."
          composer --version
          echo "âœ… Composer is installed"

      - name: Install Composer dependencies for plugin
        run: |
          echo "ðŸ“¦ Installing Composer plugin dependencies..."
          cd scripts/ecosystem/composer-plugin
          composer install
          echo "âœ… Dependencies installed"

      - name: Test Composer command execution
        run: |
          echo "ðŸ§ª Testing Composer plugin command..."
          mkdir -p test-with-composer && cd test-with-composer
          echo '{"name": "test/composer-project", "description": "Test with real Composer"}' > composer.json
          cp -r ../scripts/ecosystem/composer-plugin .
          cd composer-plugin
          composer install
          cd ..

          php -r "require 'composer-plugin/vendor/autoload.php'; \$plugin = new CoreX\\AIMindLayer\\ComposerPlugin(); \$io = new Composer\\IO\\NullIO(); \$plugin->updateAiJson(\$io);"

          test -f .ai.json && echo "âœ… Composer plugin works with real Composer installation"
          cat .ai.json
          cd .. && rm -rf test-with-composer
